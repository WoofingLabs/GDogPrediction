<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GDOG Prediction</title>
    <link rel="icon" type="image/png" href="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Changa+One&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0068FF',
                        secondary: '#18E5A0',
                        dark: '#070808',
                        'light-gray': '#E5E7EB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Changa One', 'system-ui', 'sans-serif']
                    },
                    animation: { float: 'float 3s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-8px)' } } }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow-glow { text-shadow: 0 0 10px rgba(0, 104, 255, 0.5); }
            .glow-border { box-shadow: 0 0 12px rgba(24, 229, 160, 0.3); }
        }
    </style>
</head>
<body class="bg-dark text-white font-sans overflow-x-hidden">

    <header class="fixed w-full z-50 bg-dark/90 backdrop-blur-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" alt="GDOG" class="w-10 h-10 rounded-full" />
                <span class="font-display text-3xl text-primary text-shadow-glow">GDOG Prediction</span>
            </div>
            <button id="connectWalletButton" class="px-5 py-2 bg-primary rounded-full font-medium hover:bg-primary/80 transition">
                连接钱包
            </button>
        </div>
    </header>

    <section class="min-h-screen pt-24 pb-16 px-4">
        <div class="container mx-auto max-w-5xl">

            <div class="text-center mb-12">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" alt="GDOG" class="w-32 h-32 mx-auto mb-4 animate-float rounded-full border-4 border-secondary/50 glow-border" />
                <h1 class="font-display text-6xl text-primary text-shadow-glow">GDOG 预测市场</h1>
                <p class="text-light-gray mt-3 text-lg">用 GDOG 预测事件结果，赢取奖池！</p>
            </div>

            <div id="ownerPanel" class="hidden bg-dark/50 border border-primary/30 rounded-xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-secondary mb-4">Owner 管理面板</h2>
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <input id="yesText" placeholder="Yes 选项（如：特朗普当选）" class="px-4 py-3 bg-dark/80 border border-primary/30 rounded-lg focus:outline-none focus:border-secondary">
                    <input id="noText" placeholder="No 选项（如：特朗普落选）" class="px-4 py-3 bg-dark/80 border border-primary/30 rounded-lg focus:outline-none focus:border-secondary">
                    <input id="hours" type="number" placeholder="投注时长（小时）" min="1" max="720" class="px-4 py-3 bg-dark/80 border border-primary/30 rounded-lg focus:outline-none focus:border-secondary">
                </div>
                <button id="createEventBtn" class="w-full py-3 bg-secondary text-dark font-bold rounded-full hover:bg-secondary/80 transition">
                    创建新预测事件
                </button>
            </div>

            <div id="eventsList" class="space-y-6">
                <p class="text-center text-light-gray">加载中...</p>
            </div>

            <div id="status" class="text-center text-light-gray text-sm min-h-6 mt-8"></div>
        </div>
    </section>

    <footer class="bg-dark/95 py-8 border-t border-primary/20 text-center text-light-gray text-sm">
        合约地址: 0x9567BB996f01eF0f634B553efD71CcC53F2D303f © 2025 GDOG Prediction
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = '0x9567BB996f01eF0f634B553efD71CcC53F2D303f';
        const GDOG_ADDRESS = '0xf6D9Cf57e20bA0d33372E8998A9424aa53411E04';

        const contractABI = [
            {"inputs":[{"internalType":"string","name":"yes","type":"string"},{"internalType":"string","name":"no","type":"string"},{"internalType":"uint64","name":"bettingHours","type":"uint64"}],"name":"create","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"bool","name":"yes","type":"bool"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"bet","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"bool","name":"yesWins","type":"bool"}],"name":"resolve","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"events","outputs":[
                {"internalType":"string","name":"optionYes","type":"string"},
                {"internalType":"string","name":"optionNo","type":"string"},
                {"internalType":"uint64","name":"startTime","type":"uint64"},
                {"internalType":"uint64","name":"bettingDeadline","type":"uint64"},
                {"internalType":"uint128","name":"totalYes","type":"uint128"},
                {"internalType":"uint128","name":"totalNo","type":"uint128"},
                {"internalType":"uint64","name":"resolvedTime","type":"uint64"},
                {"internalType":"bool","name":"yesWins","type":"bool"}
            ],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"userBets","outputs":[
                {"internalType":"uint256","name":"yes","type":"uint256"},
                {"internalType":"uint256","name":"no","type":"uint256"}
            ],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"nextEventId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}
        ];

        const erc20ABI = [
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
        ];

        let web3, account, contract, gdogToken, isOwner = false;

        async function init() {
            if (!window.ethereum) {
                document.getElementById('status').textContent = '请安装 MetaMask';
                return;
            }
            web3 = new Web3(window.ethereum);
            await switchToGateLayer();
            document.getElementById('connectWalletButton').onclick = connectWallet;
            await connectWallet();
        }

        async function switchToGateLayer() {
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x2768' }],
                });
            } catch (e) {
                if (e.code === 4902) {
                    await ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x2768',
                            chainName: 'Gate Layer',
                            rpcUrls: ['https://gatelayer-mainnet.gatenode.cc/'],
                            nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 },
                            blockExplorerUrls: ['https://www.gatescan.org/gatelayer/']
                        }]
                    });
                }
            }
        }

        async function connectWallet() {
            try {
                await ethereum.request({ method: 'eth_requestAccounts' });
                account = (await web3.eth.getAccounts())[0];
                contract = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);
                gdogToken = new web3.eth.Contract(erc20ABI, GDOG_ADDRESS);

                const owner = await contract.methods.owner().call();
                isOwner = owner.toLowerCase() === account.toLowerCase();
                if (isOwner) document.getElementById('ownerPanel').classList.remove('hidden');

                document.getElementById('connectWalletButton').innerHTML = 
                    `已连接: ${account.slice(0,6)}...${account.slice(-4)}`;
                document.getElementById('connectWalletButton').disabled = true;

                loadEvents();
                setInterval(loadEvents, 15000);
            } catch (err) {
                document.getElementById('status').textContent = '连接失败';
            }
        }

        async function approveGDOG(amountWei) {
            const allowance = await gdogToken.methods.allowance(account, CONTRACT_ADDRESS).call();
            if (BigInt(allowance) >= BigInt(amountWei)) return true;
            document.getElementById('status').textContent = '正在授权 GDOG...';
            await gdogToken.methods.approve(CONTRACT_ADDRESS, '115792089237316195423570985008687907853269984665640564039457584007913129639935').send({ from: account });
            document.getElementById('status').textContent = '授权成功';
            return true;
        }

        document.getElementById('createEventBtn')?.addEventListener('click', async () => {
            const yes = document.getElementById('yesText').value.trim();
            const no = document.getElementById('noText').value.trim();
            const hours = document.getElementById('hours').value;
            if (!yes || !no || !hours) return alert('请填写完整');
            document.getElementById('status').textContent = '创建事件中...';
            try {
                await contract.methods.create(yes, no, hours).send({ from: account });
                document.getElementById('status').textContent = '事件创建成功！';
                document.getElementById('yesText').value = '';
                document.getElementById('noText').value = '';
                document.getElementById('hours').value = '';
                loadEvents();
            } catch (e) {
                document.getElementById('status').textContent = '创建失败';
            }
        });

        async function loadEvents() {
            const container = document.getElementById('eventsList');
            container.innerHTML = '';
            try {
                const nextId = await contract.methods.nextEventId().call();
                for (let id = 1; id < nextId; id++) {
                    const e = await contract.methods.events(id).call();
                    const userBet = await contract.methods.userBets(id, account || '0x0').call();
                    const now = Math.floor(Date.now() / 1000);

                    const card = document.createElement('div');
                    card.className = 'bg-dark/50 border border-primary/30 rounded-xl p-6';

                    const deadline = new Date(e.bettingDeadline * 1000).toLocaleString();
                    const resolved = e.resolvedTime > 0;
                    const bettingOpen = now <= e.bettingDeadline && !resolved;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-secondary">#${id} ${e.optionYes} vs ${e.optionNo}</h3>
                                <p class="text-light-gray text-sm">截止时间: ${deadline}</p>
                                ${resolved ? `<p class="text-lg font-bold ${e.yesWins ? 'text-green-400' : 'text-red-400'}">
                                    结果: ${e.yesWins ? 'Yes 胜' : 'No 胜'}
                                </p>` : ''}
                            </div>
                            ${isOwner && !resolved ? `<div class="space-x-2">
                                <button onclick="resolveEvent(${id}, true)" class="px-4 py-2 bg-green-600 rounded-lg text-sm hover:bg-green-500">Yes 胜</button>
                                <button onclick="resolveEvent(${id}, false)" class="px-4 py-2 bg-red-600 rounded-lg text-sm hover:bg-red-500">No 胜</button>
                            </div>` : ''}
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                            <div class="bg-blue-900/30 rounded-lg p-4">
                                <p class="text-2xl font-bold text-primary">${web3.utils.fromWei(e.totalYes, 'ether')}</p>
                                <p class="text-sm text-light-gray">Yes 总投注</p>
                            </div>
                            <div class="bg-red-900/30 rounded-lg p-4">
                                <p class="text-2xl font-bold text-secondary">${web3.utils.fromWei(e.totalNo, 'ether')}</p>
                                <p class="text-sm text-light-gray">No 总投注</p>
                            </div>
                        </div>

                        <div class="text-sm text-light-gray space-y-1">
                            <div>你投 Yes: ${web3.utils.fromWei(userBet[0], 'ether')} GDOG</div>
                            <div>你投 No: ${web3.utils.fromWei(userBet[1], 'ether')} GDOG</div>
                        </div>

                        ${bettingOpen ? `
                        <div class="mt-4 flex gap-3">
                            <input type="text" id="betAmount${id}" placeholder="投注数量" class="flex-1 px-4 py-2 bg-dark/80 border border-primary/30 rounded-lg focus:outline-none focus:border-secondary">
                            <button onclick="placeBet(${id}, true)" class="px-6 py-2 bg-primary rounded-lg hover:bg-primary/80">投 Yes</button>
                            <button onclick="placeBet(${id}, false)" class="px-6 py-2 bg-secondary text-dark rounded-lg hover:bg-secondary/80">投 No</button>
                        </div>` : ''}

                        ${resolved && (userBet[0] > 0 || userBet[1] > 0) ? `
                        <button onclick="claimReward(${id})" class="mt-4 w-full py-3 bg-gradient-to-r from-primary to-secondary rounded-full font-bold hover:opacity-90">
                            ${((e.yesWins && userBet[0] > 0) || (!e.yesWins && userBet[1] > 0)) ? '领取奖励' : '已无奖励可领'}
                        </button>` : ''}
                    `;
                    container.appendChild(card);
                }
                if (nextId == 1) container.innerHTML = '<p class="text-center text-light-gray text-xl">暂无预测事件</p>';
            } catch (e) {
                console.error(e);
            }
        }

        window.placeBet = async (id, yes) => {
            const input = document.getElementById(`betAmount${id}`);
            const amount = input.value.trim();
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return alert('请输入有效数量');
            const wei = web3.utils.toWei(amount, 'ether');
            document.getElementById('status').textContent = '授权/投注中...';
            try {
                await approveGDOG(wei);
                await contract.methods.bet(id, yes, wei).send({ from: account });
                document.getElementById('status').textContent = '投注成功！';
                input.value = '';
                loadEvents();
            } catch (e) {
                document.getElementById('status').textContent = e.message.includes('User denied') ? '已取消交易' : '投注失败';
            }
        };

        window.claimReward = async (id) => {
            document.getElementById('status').textContent = '领取中...';
            try {
                await contract.methods.claim(id).send({ from: account });
                document.getElementById('status').textContent = '领取成功！';
                loadEvents();
            } catch (e) {
                document.getElementById('status').textContent = '领取失败或无奖励';
            }
        };

        window.resolveEvent = async (id, yesWins) => {
            if (!confirm(`确定让 ${yesWins ? 'Yes' : 'No'} 获胜？`)) return;
            document.getElementById('status').textContent = '结算事件中...';
            try {
                await contract.methods.resolve(id, yesWins).send({ from: account });
                document.getElementById('status').textContent = '事件已结算';
                loadEvents();
            } catch (e) {
                document.getElementById('status').textContent = '结算失败';
            }
        };

        window.addEventListener('load', init);
    </script>
</body>
</html>
