<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GDOG 预测市场</title>
    <link rel="icon" type="image/png" href="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#0068FF', secondary: '#18E5A0', accent: '#FFD700', dark: '#070808', 'light-gray': '#E5E7EB' },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], display: ['Changa One', 'system-ui', 'sans-serif'] },
                    animation: { 'float': 'float 3s ease-in-out infinite' },
                    keyframes: { float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-12px)' } } }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow-glow { text-shadow: 0 0 15px rgba(0,104,255,0.8); }
            .glow-border { box-shadow: 0 0 20px rgba(24,229,160,0.6); }
            .bg-grid { background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="1" cy="1" r="1" fill="%230068FF" fill-opacity="0.12"/%3E%3C/svg%3E'); background-size: 20px 20px; }
            .input-field { @apply w-full px-5 py-4 bg-white/10 border-2 border-primary/50 rounded-xl text-white placeholder-gray-500 text-lg focus:outline-none focus:border-secondary focus:ring-4 focus:ring-secondary/30 transition-all backdrop-blur-sm; }
            .btn-primary { @apply w-full py-5 bg-gradient-to-r from-primary to-secondary text-black font-bold text-xl rounded-xl hover:scale-105 transition-all shadow-2xl; }
        }
    </style>
</head>
<body class="bg-dark text-white overflow-x-hidden">
    <header class="fixed w-full z-50 bg-dark/90 backdrop-blur-md border-b border-primary/30">
        <div class="container mx-auto px-6 py-5 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" class="w-12 h-12 rounded-full glow-border">
                <h1 class="font-display text-4xl text-primary text-shadow-glow">GDOG 预测市场</h1>
            </div>
            <button id="connectWalletButton" class="px-8 py-3 bg-gradient-to-r from-primary to-secondary text-black font-bold rounded-full hover:scale-110 transition-all shadow-lg">
                连接钱包
            </button>
        </div>
    </header>

    <section class="min-h-screen pt-32 pb-20 bg-grid relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-primary/5 to-dark"></div>
        <div class="absolute top-10 left-10 w-96 h-96 bg-primary/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-10 right-10 w-96 h-96 bg-secondary/10 rounded-full blur-3xl"></div>

        <div class="container mx-auto px-6 text-center relative z-10">
            <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" class="w-40 h-40 mx-auto animate-float glow-border mb-8">
            <h2 class="font-display text-6xl md:text-8xl mb-6 text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary text-shadow-glow">GDOG PREDICTION</h2>
            <p class="text-2xl text-light-gray mb-16">输家归赢家 · 零手续费 · 完全链上公平</p>

            <div id="ownerPanel" class="hidden max-w-4xl mx-auto bg-white/5 backdrop-blur-xl rounded-2xl p-10 border border-primary/40 glow-border mb-12">
                <h3 class="text-3xl font-bold text-secondary mb-8">Owner 创建新事件</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <input id="optionYes" class="input-field" placeholder="Yes 选项">
                    <input id="optionNo" class="input-field" placeholder="No 选项">
                    <input id="hours" type="number" class="input-field" placeholder="下注时长（小时）" value="24">
                    <button id="createBtn" class="btn-primary">创建事件</button>
                </div>
            </div>

            <div id="eventsList" class="max-w-5xl mx-auto space-y-8">
                <div class="text-center py-32 text-2xl text-gray-400">点击右上角连接钱包</div>
            </div>
        </div>
    </section>

    <div id="betModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-50">
        <div class="bg-gradient-to-br from-dark via-primary/10 to-dark rounded-3xl p-10 max-w-md w-full mx-4 border-2 border-secondary glow-border">
            <h3 id="modalTitle" class="text-3xl font-bold text-center mb-8 text-secondary"></h3>
            <div id="deadlineInfo" class="text-center text-gray-300 mb-6"></div>
            <div class="grid grid-cols-2 gap-6 mb-8">
                <button id="betYesBtn" class="py-5 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-2xl font-bold text-xl hover:scale-105 transition">押 Yes</button>
                <button id="betNoBtn" class="py-5 bg-gradient-to-r from-red-600 to-pink-600 rounded-2xl font-bold text-xl hover:scale-105 transition">押 No</button>
            </div>
            <input id="betAmount" type="number" placeholder="输入整数 GDOG 数量" class="input-field text-center text-2xl mb-4">
            <p class="text-center text-gray-300 mb-8">你已押 Yes: <span id="userYes">0</span> | No: <span id="userNo">0</span></p>
            <div class="flex gap-4">
                <button id="closeModal" class="flex-1 py-4 bg-gray-700 rounded-xl hover:bg-gray-600 transition">取消</button>
                <button id="confirmBet" class="flex-1 btn-primary hidden">确认下注</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const CONTRACT = "0x9567BB996f01eF0f634B553efD71CcC53F2D303f";
        const OWNER = "0xfb10e2b3f29931f8372680877f1e4b3a139d9fa3".toLowerCase();

        const chains = {
            GateLayer: {
                chainId: 10088,
                chainName: 'Gate Layer',
                rpcUrl: 'https://gatelayer-mainnet.gatenode.cc',
                blockExplorer: 'https://www.gatescan.org/gatelayer/',
                nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 }
            }
        };

        const abi = [
            {"inputs":[],"name":"owner","outputs":[{"type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"type":"uint256"}],"name":"events","outputs":[
                {"name":"optionYes","type":"string"},
                {"name":"optionNo","type":"string"},
                {"name":"startTime","type":"uint64"},
                {"name":"bettingDeadline","type":"uint64"},
                {"name":"totalYes","type":"uint128"},
                {"name":"totalNo","type":"uint128"},
                {"name":"resolvedTime","type":"uint64"},
                {"name":"yesWins","type":"bool"}
            ],"stateMutability":"view","type":"function"},
            {"inputs":[{"type":"uint256"},{"type":"address"}],"name":"userBets","outputs":[{"type":"uint256"},{"type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"nextEventId","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"type":"string"},{"type":"string"},{"type":"uint64"}],"name":"create","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"type":"uint256"},{"type":"bool"},{"type":"uint256"}],"name":"bet","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"type":"uint256"},{"type":"bool"}],"name":"resolve","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"type":"uint256"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        let web3, account, contract, isOwner = false;
        let currentEventId, currentIsYes;

        async function initializeWeb3() {
            if (!window.ethereum) return alert("请安装 MetaMask");
            web3 = new Web3(window.ethereum);
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = (await web3.eth.getAccounts())[0];
                document.getElementById('connectWalletButton').innerHTML = `Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
                await switchNetwork('GateLayer');
                contract = new web3.eth.Contract(abi, CONTRACT);
                const realOwner = await contract.methods.owner().call();
                isOwner = account.toLowerCase() === realOwner.toLowerCase();
                if (isOwner) document.getElementById('ownerPanel').classList.remove('hidden');
                loadEvents();
                setInterval(loadEvents, 15000);
            } catch (e) { alert("连接失败：" + e.message); }
        }

        async function switchNetwork(chain) {
            const c = chains[chain];
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${c.chainId.toString(16)}` }]
                });
            } catch (e) {
                if (e.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: `0x${c.chainId.toString(16)}`,
                            chainName: c.chainName,
                            rpcUrls: [c.rpcUrl],
                            nativeCurrency: c.nativeCurrency,
                            blockExplorerUrls: [c.blockExplorer]
                        }]
                    });
                }
            }
        }

        async function loadEvents() {
            if (!contract || !account) return;
            const list = document.getElementById('eventsList');
            list.innerHTML = '<div class="text-center py-20 text-gray-400">加载中...</div>';
            try {
                const latest = Number(await contract.methods.nextEventId().call()) - 1;
                let html = '';
                for (let i = latest; i >= Math.max(0, latest-19); i--) {
                    const e = await contract.methods.events(i+1).call();
                    const [uYes, uNo] = await contract.methods.userBets(i+1, account).call();
                    const deadline = Number(e.bettingDeadline) * 1000;
                    const now = Date.now();
                    const closed = now > deadline;
                    const resolved = e.resolvedTime > 0;

                    html += `
                    <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-8 border border-primary/40 glow-border">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <span class="text-gray-400">#${i+1}</span>
                                <h3 class="text-2xl font-bold mt-1">${e.optionYes} <span class="text-gray-500">vs</span> ${e.optionNo}</h3>
                                <p class="text-sm text-gray-400 mt-2">${closed?'下注已结束':`剩余 ${formatTime(deadline-now)}`}${resolved?` · ${e.yesWins?'Yes赢':'No赢'}`:''}</p>
                            </div>
                            ${isOwner && closed && !resolved ? `<div class="flex gap-3">
                                <button onclick="resolveEvent(${i+1},true)" class="px-6 py-2 bg-green-600 rounded-lg hover:bg-green-500">Yes赢</button>
                                <button onclick="resolveEvent(${i+1},false)" class="px-6 py-2 bg-red-600 rounded-lg hover:bg-red-500">No赢</button>
                            </div>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-8 text-center">
                            <div class="bg-emerald-900/30 rounded-xl p-6">
                                <p class="text-4xl font-bold text-cyan-400">${web3.utils.fromWei(e.totalYes,'ether')}</p>
                                <p class="text-lg">Yes · ${e.optionYes}</p>
                                <p class="text-sm text-gray-400">你已押 ${web3.utils.fromWei(uYes,'ether')}</p>
                            </div>
                            <div class="bg-red-900/30 rounded-xl p-6">
                                <p class="text-4xl font-bold text-red-400">${web3.utils.fromWei(e.totalNo,'ether')}</p>
                                <p class="text-lg">No · ${e.optionNo}</p>
                                <p class="text-sm text-gray-400">你已押 ${web3.utils.fromWei(uNo,'ether')}</p>
                            </div>
                        </div>
                        ${resolved ? `<button onclick="claim(${i+1})" class="w-full mt-8 btn-primary ${(e.yesWins&&uYes>0)||(!e.yesWins&&uNo>0)?'':'opacity-50'}">
                            ${(e.yesWins&&uYes>0)||(!e.yesWins&&uNo>0)?'领取收益':'已结束'}</button>` 
                            : closed ? '<p class="text-center mt-8 text-gray-400">等待开奖</p>' 
                            : `<button onclick="openModal(${i+1},'${e.optionYes}','${e.optionNo}',${e.bettingDeadline})" class="w-full mt-8 btn-primary">立即下注</button>`}
                    </div>`;
                }
                list.innerHTML = html || '<div class="text-center py-20 text-gray-400">暂无事件</div>';
            } catch (e) { list.innerHTML = '<div class="text-red-400 text-center py-20">加载失败：'+e.message+'</div>'; }
        }

        function formatTime(t){ if(t<=0) return'已结束'; const h=Math.floor(t/36e5),m=Math.floor(t%36e5/6e4); return h+'小时'+m+'分'; }

        function openModal(id,yes,no,deadline){ currentEventId=id; document.getElementById('modalTitle').textContent=`${yes} vs ${no}`; document.getElementById('deadlineInfo').textContent=`截止时间: ${new Date(deadline*1000).toLocaleString()}`; document.getElementById('betAmount').value=''; document.getElementById('confirmBet').classList.add('hidden'); loadUserBetsInModal(); document.getElementById('betModal').classList.remove('hidden'); }

        async function loadUserBetsInModal(){ const [y,n]=await contract.methods.userBets(currentEventId,account).call(); document.getElementById('userYes').textContent=web3.utils.fromWei(y,'ether'); document.getElementById('userNo').textContent=web3.utils.fromWei(n,'ether'); }

        document.getElementById('betYesBtn').onclick=()=>{currentIsYes=true;document.getElementById('confirmBet').classList.remove('hidden');};
        document.getElementById('betNoBtn').onclick=()=>{currentIsYes=false;document.getElementById('confirmBet').classList.remove('hidden');};
        document.getElementById('closeModal').onclick=()=>document.getElementById('betModal').classList.add('hidden');
        document.getElementById('confirmBet').onclick=async()=>{ const amt=document.getElementById('betAmount').value; if(!amt||amt<=0)return alert('请输入数量'); await contract.methods.bet(currentEventId,currentIsYes,web3.utils.toWei(amt,'ether')).send({from:account}); alert('下注成功'); document.getElementById('betModal').classList.add('hidden'); loadEvents(); };

        async function resolveEvent(id,yesWins){ if(!confirm(`确认${yesWins?'Yes':'No'}获胜？`))return; await contract.methods.resolve(id,yesWins).send({from:account}); alert('开奖成功'); loadEvents(); }
        async function claim(id){ await contract.methods.claim(id).send({from:account}); alert('领取成功'); loadEvents(); }

        document.getElementById('createBtn').onclick=async()=>{
            const yes=document.getElementById('optionYes').value.trim();
            const no=document.getElementById('optionNo').value.trim();
            const h=document.getElementById('hours').value;
            if(!yes||!no||!h)return alert('请填写完整');
            await contract.methods.create(yes,no,h).send({from:account});
            alert('创建成功'); document.getElementById('optionYes').value=''; document.getElementById('optionNo').value=''; loadEvents();
        };

        document.getElementById('connectWalletButton').onclick = initializeWeb3;
    </script>
</body>
</html>
