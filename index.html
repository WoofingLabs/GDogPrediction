<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GDOG 预测市场</title>
    <link rel="icon" type="image/png" href="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #0a0e17 0%, #1a0033 100%); font-family: 'Rajdhani', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(0, 255, 255, 0.2); }
        .glow-btn { 
            background: linear-gradient(45deg, #00F5FF, #00FF88);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            animation: pulse 2s infinite;
        }
        .glow-btn:hover { box-shadow: 0 0 30px rgba(0, 255, 255, 0.8); }
        .glow-yes { box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); }
        .glow-no { box-shadow: 0 0 25px rgba(0, 255, 136, 0.6); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .number { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        .mobile-bottom { @apply pb-32 sm:pb-10; }
    </style>
</head>
<body class="min-h-screen text-white overflow-x-hidden">

    <!-- 背景粒子特效 -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute top-10 left-10 w-96 h-96 bg-cyan-500 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-pulse"></div>
        <div class="absolute bottom-20 right-10 w-96 h-96 bg-emerald-500 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-pulse delay-1000"></div>
    </div>

    <header class="fixed top-0 left-0 right-0 z-50 glass border-b border-cyan-500/30">
        <div class="container mx-auto px-6 py-5 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" class="w-12 h-12 rounded-full ring-4 ring-cyan-500/50">
                <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent">
                    GDOG 预测市场
                </h1>
            </div>
        </div>
    </header>

    <main class="pt-24 px-4 max-w-5xl mx-auto mobile-bottom">
        <div class="text-center mb-10">
            <div class="w-32 h-32 mx-auto mb-6 animate-bounce">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" class="w-full h-full rounded-full ring-8 ring-cyan-500/30">
            </div>
            <h2 class="text-5xl sm:text-7xl font-black mb-4 bg-gradient-to-r from-cyan-400 via-blue-500 to-emerald-400 bg-clip-text text-transparent">
                TO THE MOON
            </h2>
            <p class="text-xl text-cyan-300">输入事件 ID，参与预测，赢取全部奖池</p>
        </div>

        <!-- 主卡片 -->
        <div class="glass rounded-3xl p-8 shadow-2xl border border-cyan-500/40">
            <!-- 连接钱包 -->
            <button id="connectWalletButton" class="w-full py-5 rounded-2xl text-2xl font-bold glow-btn text-black mb-6">
                连接钱包
            </button>

            <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                <div id="networkStatus" class="text-cyan-400 text-center">等待连接...</div>
                <div id="balanceStatus" class="text-emerald-400 text-center">余额加载中...</div>
            </div>

            <!-- 事件ID输入 -->
            <input id="eventId" type="number" min="1" placeholder="输入事件 ID" 
                   class="w-full px-8 py-5 text-2xl text-center rounded-2xl glass border border-cyan-500/50 focus:border-cyan-300 focus:outline-none mb-8">

            <!-- 事件内容卡片 -->
            <div id="eventCard" class="hidden space-y-8">
                <div class="text-center">
                    <h3 id="title" class="text-3xl sm:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-emerald-400 mb-3"></h3>
                    <p id="deadline" class="text-xl text-cyan-300"></p>
                </div>

                <!-- 奖池显示 -->
                <div class="grid grid-cols-2 gap-6 my-10">
                    <div class="glass rounded-2xl p-8 text-center glow-yes transform hover:scale-105 transition">
                        <p class="text-cyan-400 text-lg mb-2">YES 奖池</p>
                        <p id="poolYes" class="number text-5xl sm:text-7xl font-black text-cyan-300">0</p>
                    </div>
                    <div class="glass rounded-2xl p-8 text-center glow-no transform hover:scale-105 transition">
                        <p class="text-emerald-400 text-lg mb-2">NO 奖池</p>
                        <p id="poolNo" class="number text-5xl sm:text-7xl font-black text-emerald-300">0</p>
                    </div>
                </div>

                <!-- 投注区 -->
                <div id="betSection" class="space-y-6">
                    <input id="betAmount" type="text" placeholder="输入投注数量（GDOG）" 
                           class="w-full px-8 py-6 text-2xl text-center rounded-2xl glass border-2 border-cyan-500/50 focus:border-emerald-400 focus:outline-none">
                    <div class="grid grid-cols-2 gap-6">
                        <button id="betYesBtn" class="py-6 rounded-2xl text-3xl font-black bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 transform hover:scale-105 transition shadow-lg">
                            YES
                        </button>
                        <button id="betNoBtn" class="py-6 rounded-2xl text-3xl font-black bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 transform hover:scale-105 transition shadow-lg">
                            NO
                        </button>
                    </div>
                </div>

                <!-- 领取按钮 -->
                <button id="claimBtn" class="hidden w-full py-6 rounded-2xl text-3xl font-black glow-btn text-black transform hover:scale-105 transition">
                    领取奖励
                </button>
            </div>

            <p id="status" class="text-center text-xl mt-8 min-h-12 text-cyan-300 font-semibold"></p>
        </div>
    </main>

    <footer class="text-center py-8 text-cyan-600 text-sm">
        合约: 0x9567BB996f01eF0f634B553efD71CcC53F2D303f • GateLayer 主网
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const CONTRACT = '0x9567BB996f01eF0f634B553efD71CcC53F2D303f';
        const GDOG = '0xf6D9Cf57e20bA0d33372E8998A9424aa53411E04';

        const ABI = [{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"bool","name":"yes","type":"bool"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"bet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"events","outputs":[{"internalType":"string","name":"optionYes","type":"string"},{"internalType":"string","name":"optionNo","type":"string"},{"internalType":"uint64","name":"bettingDeadline","type":"uint64"},{"internalType":"uint128","name":"totalYes","type":"uint128"},{"internalType":"uint128","name":"totalNo","type":"uint128"},{"internalType":"uint64","name":"resolvedTime","type":"uint64"},{"internalType":"bool","name":"yesWins","type":"bool"}],"stateMutability":"view","type":"function"}];

        const ERC20_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

        let web3, account, contract, token;

        const chainConfig = {chainId:10088,chainName:"Gate Layer",rpcUrls:["https://gatelayer-mainnet.gatenode.cc/"],nativeCurrency:{name:"GT",symbol:"GT",decimals:18},blockExplorerUrls:["https://www.gatescan.org/gatelayer/"]};

        async function init() {
            if (!window.ethereum) return status("请安装 MetaMask");
            web3 = new Web3(window.ethereum);
            try {
                await ethereum.request({method:'eth_requestAccounts'});
                account = (await web3.eth.getAccounts())[0];
                await switchToGateLayer();
                contract = new web3.eth.Contract(ABI, CONTRACT);
                token = new web3.eth.Contract(ERC20_ABI, GDOG);
                document.getElementById('connectWalletButton').innerHTML = `已连接 ${account.slice(0,6)}...${account.slice(-4)}`;
                document.getElementById('connectWalletButton').disabled = true;
                document.getElementById('networkStatus').textContent = "GateLayer 主网";
                updateBalance(); setInterval(updateBalance, 8000);
                status("连接成功！请输入事件 ID");
            } catch { status("连接被拒绝"); }
        }

        async function switchToGateLayer() {
            try {
                await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x' + (10088).toString(16)}]});
            } catch (e) {
                if (e.code === 4902) await ethereum.request({method:'wallet_addEthereumChain', params:[chainConfig]});
            }
        }

        async function updateBalance() {
            if (!account) return;
            try {
                const b = await token.methods.balanceOf(account).call();
                document.getElementById('balanceStatus').textContent = `余额 ${Math.floor(web3.utils.fromWei(b,'ether')).toLocaleString()} GDOG`;
            } catch {}
        }

        function status(msg) { document.getElementById('status').textContent = msg; }

        async function loadEvent() {
            const id = document.getElementById('eventId').value.trim();
            if (!id || !contract) return;
            try {
                const e = await contract.methods.events(id).call();
                if (!e.optionYes) throw '';
                const now = Date.now()/1000;
                const open = now <= e.bettingDeadline && e.resolvedTime == 0;
                const resolved = e.resolvedTime > 0;

                document.getElementById('title').textContent = `${e.optionYes} vs ${e.optionNo}`;
                document.getElementById('deadline').textContent = `截止 ${new Date(e.bettingDeadline*1000).toLocaleString()}`;
                document.getElementById('poolYes').textContent = Math.floor(web3.utils.fromWei(e.totalYes,'ether')).toLocaleString();
                document.getElementById('poolNo').textContent = Math.floor(web3.utils.fromWei(e.totalNo,'ether')).toLocaleString();

                document.getElementById('betSection').style.display = open ? 'block' : 'none';
                document.getElementById('claimBtn').classList.toggle('hidden', !resolved);
                if (resolved) document.getElementById('claimBtn').textContent = e.yesWins ? 'YES 胜 → 领取奖励' : 'NO 胜 → 领取奖励';

                document.getElementById('eventCard').classList.remove('hidden');
                status(`事件 #${id} 已加载`);
            } catch { status("事件不存在或已结束"); }
        }

        async function approveIfNeeded(wei) {
            const allow = await token.methods.allowance(account, CONTRACT).call();
            if (BigInt(allow) >= BigInt(wei)) return;
            status("请授权 GDOG...");
            await token.methods.approve(CONTRACT, "115792089237316195423570985008687907853269984665640564039457584007913129639935").send({from:account});
            status("授权成功！");
        }

        async function placeBet(yes) {
            const amt = document.getElementById('betAmount').value.trim();
            if (!amt || Number(amt)<=0) return status("请输入正确数量");
            const wei = web3.utils.toWei(amt,'ether');
            const id = document.getElementById('eventId').value;
            try {
                await approveIfNeeded(wei);
                status("投注进行中...");
                await contract.methods.bet(id, yes, wei).send({from:account});
                status("投注成功！");
                document.getElementById('betAmount').value = '';
                setTimeout(loadEvent, 3000);
            } catch { status("投注失败或已取消"); }
        }

        async function claim() {
            const id = document.getElementById('eventId').value;
            status("领取中...");
            try {
                await contract.methods.claim(id).send({from:account});
                status("领取成功！");
                setTimeout(loadEvent, 3000);
            } catch { status("无奖励或已领取"); }
        }

        document.getElementById('connectWalletButton').onclick = init;
        document.getElementById('eventId').onchange = loadEvent;
        document.getElementById('betYesBtn').onclick = () => placeBet(true);
        document.getElementById('betNoBtn').onclick = () => placeBet(false);
        document.getElementById('claimBtn').onclick = claim;

        window.onload = () => window.ethereum?.selectedAddress && init();
    </script>
</body>
</html>
